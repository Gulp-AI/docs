---
title: "State Management"
description: "Comprehensive guide to state management and infrastructure provisioning in Gulp"
---

# State Management

Gulp provides automated state management and infrastructure provisioning through the Gulp Web Tool, which handles all the underlying complexity of setting up and maintaining state backends. This guide covers everything from basic setup to advanced configurations and troubleshooting.

<Note>
State management is a critical component of any Flink application. Gulp abstracts away the complexity while maintaining full configurability for advanced users.
</Note>

## Automated Infrastructure Provisioning

Gulp Web Tool automatically provisions and manages the required infrastructure based on your cloud provider. Our infrastructure-as-code approach ensures consistency and reliability.

### AWS Infrastructure

```yaml
infrastructure:
  provider: "aws"
  region: "us-west-2"
  stateBackend:
    type: "rocksdb"  # Automatically provisioned via CloudFormation
    checkpointInterval: "5m"
    incrementalCheckpoints: true
    localRecovery: true
    rocksdb:
      predefinedOptions: "FLASH_SSD_OPTIMIZED"
      compactionStyle: "LEVEL"
      blockSize: "64kb"
      writeBufferSize: "64mb"
      
  resources:
    # Automatically provisioned and configured
    - s3StateBackend:
        bucketName: "gulp-${ENVIRONMENT}-flink-state"
        encryption: "KMS"
        versioning: true
        lifecycle:
          transitionDays: 30
          expirationDays: 90
    - dynamoDbCheckpoints:
        tableName: "gulp-${ENVIRONMENT}-checkpoints"
        readCapacity: "auto"
        writeCapacity: "auto"
    - cloudwatchMetrics:
        namespace: "Gulp/Flink"
        retention: 90
    - iamRoles:
        permissions: "least-privilege"
```

<Accordion title="AWS Infrastructure Details">
The Gulp Web Tool will automatically:
- Create S3 buckets for state storage with KMS encryption and versioning
- Set up DynamoDB tables with auto-scaling for checkpoint coordination
- Configure IAM roles and permissions with least privilege principle
- Set up CloudWatch metrics, dashboards, and alarms
- Manage complete infrastructure lifecycle
</Accordion>

### GCP Infrastructure

```yaml
infrastructure:
  provider: "gcp"
  region: "us-central1"
  stateBackend:
    type: "rocksdb"  # Automatically provisioned via Terraform
    checkpointInterval: "5m"
    incrementalCheckpoints: true
    localRecovery: true
    rocksdb:
      predefinedOptions: "FLASH_SSD_OPTIMIZED"
      compactionStyle: "LEVEL"
      blockSize: "64kb"
      writeBufferSize: "64mb"
    
  resources:
    # Automatically provisioned and configured
    - gcsStateBackend:
        bucketName: "gulp-${ENVIRONMENT}-flink-state"
        encryption: "CMEK"
        uniformAccess: true
        lifecycle:
          coldlineAfterDays: 30
          archiveAfterDays: 90
    - cloudSqlCheckpoints:
        instance: "gulp-${ENVIRONMENT}-checkpoints"
        tier: "db-custom-2-8192"
        highAvailability: true
    - monitoring:
        workspace: "gulp-${ENVIRONMENT}"
        retention: 90
    - serviceAccounts:
        permissions: "least-privilege"
```

<Accordion title="GCP Infrastructure Details">
The Gulp Web Tool will automatically:
- Create GCS buckets with Customer-Managed Encryption Keys (CMEK)
- Set up Cloud SQL instances with high availability for checkpoint coordination
- Configure service accounts with minimal required permissions
- Set up Cloud Monitoring workspaces with custom dashboards
- Manage complete infrastructure lifecycle
</Accordion>

## State Backend Configuration

While infrastructure is provisioned automatically, you can fine-tune state behavior:

```yaml
stateConfig:
  # Checkpointing Configuration
  checkpointing:
    mode: "exactly_once"  # exactly_once, at_least_once
    interval: "5m"
    timeout: "10m"
    minPause: "1s"
    maxConcurrent: 1
    unalignedCheckpoints: true
    alignmentTimeout: "30s"
    
  # State Backend Options
  backend:
    type: "rocksdb"  # rocksdb is recommended for production
    incrementalCheckpoints: true
    localRecovery: true
    memory:
      managedMemorySize: "256mb"
      retainedInMemory: "128mb"
    rocksdb:
      predefinedOptions: "FLASH_SSD_OPTIMIZED"
      compactionStyle: "LEVEL"
      blockSize: "64kb"
      writeBufferSize: "64mb"
      maxOpenFiles: 10000
      targetFileSize: "64mb"
      
  # Recovery Configuration
  recovery:
    mode: "latest-complete"  # latest-complete, latest-available
    restartStrategy: "fixed-delay"
    maxAttempts: 3
    failureRate:
      max: 3
      interval: "5m"
    delay:
      initial: "1s"
      maximum: "60s"
      multiplier: 2.0
```

<Tip>
**Performance Tip**: For large state sizes, enable unaligned checkpoints and tune RocksDB parameters based on your storage type and workload patterns.
</Tip>

## Managed Features

### 1. Automatic Scaling
The Gulp Web Tool implements intelligent scaling based on multiple metrics:

```yaml
scaling:
  autoScaling:
    enabled: true
    metrics:
      - type: cpu
        targetUtilization: 70
        scaleOutCooldown: "3m"
        scaleInCooldown: "5m"
      - type: memory
        targetUtilization: 80
        scaleOutCooldown: "3m"
        scaleInCooldown: "5m"
      - type: custom
        metric: "flink_taskmanager_job_latency"
        targetValue: "1000ms"
        scaleOutThreshold: "2000ms"
        scaleInThreshold: "500ms"
    minReplicas: 1
    maxReplicas: 5
    stabilizationWindowSeconds: 300
    behavior:
      scaleUp:
        policies:
          - type: Pods
            value: 1
            periodSeconds: 60
      scaleDown:
        policies:
          - type: Pods
            value: 1
            periodSeconds: 300
```

### 2. High Availability
Built-in high availability features with cloud-native implementations:

```yaml
highAvailability:
  enabled: true
  storageDir: "s3://gulp-${ENVIRONMENT}-flink-state/ha"  # or gs:// for GCP
  zookeeper:
    enabled: false  # Using cloud-native HA
  kubernetesHa:
    enabled: true
    leaseDuration: "15s"
    renewDeadline: "10s"
    retryPeriod: "2s"
  jobManagerHa:
    maxAttempts: 3
    failoverStrategy: "region"
    heartbeatTimeout: "30s"
```

### 3. Monitoring and Alerts
Comprehensive monitoring system with pre-configured dashboards:

```yaml
monitoring:
  metrics:
    - name: "checkpointDuration"
      period: "1m"
      statistic: "Average"
      dimensions:
        - job
        - task
    - name: "checkpointSize"
      period: "5m"
      statistic: "Max"
      dimensions:
        - job
        - task
    - name: "stateSize"
      period: "5m"
      statistic: "Average"
      dimensions:
        - job
        - task
    
  alerts:
    - name: "LargeStateSize"
      threshold: "10GB"
      duration: "15m"
      severity: "warning"
      notification:
        channels: ["slack", "email"]
    - name: "SlowCheckpoint"
      threshold: "5m"
      duration: "10m"
      severity: "critical"
      notification:
        channels: ["pagerduty"]
    - name: "HighRecoveryTime"
      threshold: "10m"
      duration: "5m"
      severity: "critical"
      notification:
        channels: ["pagerduty"]

  dashboards:
    - name: "State Overview"
      refresh: "30s"
      panels:
        - title: "State Size Growth"
          type: "graph"
          metrics: ["stateSize"]
        - title: "Checkpoint Performance"
          type: "graph"
          metrics: ["checkpointDuration", "checkpointSize"]
```

### 4. Cost Optimization
Intelligent cost optimization with automated lifecycle management:

```yaml
costOptimization:
  stateCleanup:
    enabled: true
    ttl: "7d"
    cleanupSchedule: "0 0 * * *"
    excludedKeys: ["critical-state-*"]
  storageClass:
    enabled: true
    transitionDelay: "30d"
    archiveDelay: "90d"
    archiveClass: "STANDARD_IA"  # or "NEARLINE" for GCP
  resourceOptimization:
    enabled: true
    scaleToZero: true
    idleTimeout: "1h"
```

## Security

The Gulp Web Tool implements comprehensive security controls:

```yaml
security:
  encryption:
    atRest:
      enabled: true
      keyType: "KMS"  # or "CMEK" for GCP
      keyRotation: "30d"
      algorithm: "AES256"
    inTransit:
      enabled: true
      tlsVersion: "1.3"
      minimumTlsVersion: "1.2"
    
  access:
    networkPolicy:
      type: "private"
      allowedCidrs: ["10.0.0.0/8"]
      serviceEndpoints: true
    authentication:
      type: "iam"
      mfa: true
      sessionDuration: "12h"
    audit:
      enabled: true
      retention: "365d"
      detailLevel: "full"
```

Features include:
- Encryption at rest using KMS/Cloud KMS with automatic key rotation
- Network isolation via VPC/VPC Service Controls with private endpoints
- IAM integration with least privilege and MFA enforcement
- Comprehensive audit logging with long-term retention

## Disaster Recovery

Enterprise-grade disaster recovery capabilities:

```yaml
disasterRecovery:
  backups:
    enabled: true
    frequency: "1h"
    retention: "7d"
    type: "incremental"
    encryption: true
    validation: true
    
  recovery:
    rpo: "1h"  # Recovery Point Objective
    rto: "15m"  # Recovery Time Objective
    crossRegion:
      enabled: true
      regions: ["us-west-2", "us-east-1"]
    testing:
      schedule: "0 0 * * 0"  # Weekly
      validation: true
```

<Warning>
Regular disaster recovery testing is crucial. Gulp automatically performs weekly recovery tests to ensure your RPO and RTO objectives can be met.
</Warning>

## Best Practices

1. **Monitoring**
   - Monitor state size growth trends
   - Track checkpoint performance metrics
   - Set up alerts for anomalies
   - Use custom dashboards for visibility

2. **Performance**
   - Use RocksDB state backend for production
   - Enable incremental checkpointing
   - Configure appropriate intervals
   - Enable local recovery
   - Tune RocksDB parameters for your workload

3. **Cost Management**
   - Enable state TTL where applicable
   - Monitor storage usage patterns
   - Use appropriate storage classes
   - Implement automated cleanup policies

4. **Security**
   - Review access patterns regularly
   - Monitor audit logs for anomalies
   - Regularly rotate encryption keys
   - Implement network isolation

## Limitations and Considerations

1. **Storage Limits**
   - Maximum state size per key group: 100GB recommended
   - Checkpoint size limitations: Based on network bandwidth
   - Recovery time considerations: Linear with state size

2. **Performance Impact**
   - Checkpoint overhead: 5-15% CPU utilization
   - Recovery time vs. state size: ~100MB/s restore rate
   - Network bandwidth requirements: Plan for 2x state size

3. **Cost Factors**
   - Storage costs: Based on state size and storage class
   - Data transfer costs: Consider cross-region replication
   - Operation costs: Backup and recovery operations

## Troubleshooting

Common issues and solutions:

1. **Checkpoint Failures**
   ```yaml
   recovery:
     checkpointFailures:
       action: "retry"
       maxAttempts: 3
       backoffPeriod: "30s"
       diagnostics:
         enabled: true
         detail: "full"
       notification:
         channels: ["slack"]
   ```

2. **State Size Issues**
   ```yaml
   stateConfig:
     cleanup:
       enabled: true
       ttl: "7d"
       cleanupInterval: "1h"
       monitoring:
         threshold: "5GB"
         action: "alert"
   ```

3. **Recovery Problems**
   ```yaml
   recovery:
     troubleshooting:
       diagnostics: true
       verboseLogging: true
       savepoint: "latest"
       metrics:
         enabled: true
         retention: "7d"
   ```

<Tip>
**Pro Tip**: Enable verbose logging temporarily during troubleshooting, but remember to disable it in production to avoid performance impact.
</Tip> 