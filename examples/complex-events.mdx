---
title: "Session Analytics"
description: "Implementing session window analytics with Gulp"
---

# Session Window Analytics

This example demonstrates how to implement session window analytics for user behavior analysis.

## User Behavior Analysis

```yaml
name: "User Behavior Analysis"
version: "1.0.0"

watermarkConfig:
  timeCharacteristic: EVENT_TIME
  timestampField: event_time
  maxOutOfOrderness: 5000

source:
  type: "kafka"
  config:
    bootstrapServers: "${KAFKA_BOOTSTRAP_SERVERS}"
    topics: ["user-events"]
    groupId: "behavior-analysis"
    startingOffsets: "latest"
    
transformations:
  - name: "Parse Events"
    type: "deserialize"
    format: "json"
    schema:
      type: "object"
      properties:
        user_id:
          type: "string"
        event_type:
          type: "string"
        event_time:
          type: "long"
          format: "unix-timestamp"
        page_id:
          type: "string"
        duration:
          type: "long"
        
  - name: "User Session Window"
    type: "window"
    keyByProperties:
      field: user_id
    windowConfig:
      windowType: SESSION
      inactivityTimeout: 1800  # 30 minutes in seconds
      timeUnit: SECONDS
      maxElementsPerWindow: 1000
      aggregateRules:
        - name: session_duration
          field: duration
          operation: sum
          fieldType: long
        - name: unique_pages
          field: page_id
          operation: count
          fieldType: long
          distinct: true
        - name: event_count
          field: event_type
          operation: count
          fieldType: long
        - name: first_page
          field: page_id
          operation: first
          fieldType: string
        - name: last_page
          field: page_id
          operation: last
          fieldType: string
        
  - name: "Session Metrics"
    type: "map"
    fields:
      - name: "avg_time_per_page"
        value: "session_duration / unique_pages"
        type: "double"
      - name: "events_per_page"
        value: "event_count / unique_pages"
        type: "double"
      - name: "session_start"
        value: "window_start"
        type: "timestamp"
      - name: "session_end"
        value: "window_end"
        type: "timestamp"
        
sink:
  type: "bigquery"
  config:
    project: "${GCP_PROJECT}"
    dataset: "analytics"
    table: "user_sessions"
    createDisposition: "CREATE_IF_NEEDED"
    writeDisposition: "WRITE_APPEND"
    partitioning:
      type: "time"
      field: "session_start"
      expirationMs: 7776000000  # 90 days
    clustering:
      fields: ["user_id", "first_page"]
```

## Configuration Details

### Watermark Configuration
- Uses event time processing
- Allows 5 seconds for out-of-order events
- Based on event_time field

### Source Configuration
- Reads from Kafka user events topic
- Latest offset consumption
- Event-time based processing

### Transformations
1. **Parse Events**: JSON deserialization with schema validation
2. **Session Window**: 
   - 30-minute inactivity gap
   - Keyed by user_id
   - Multiple aggregations per session
3. **Session Metrics**: 
   - Calculates derived metrics
   - Preserves window metadata

### Sink Configuration
- Writes to BigQuery
- Time-partitioned by session start
- Clustered for efficient user and page queries 